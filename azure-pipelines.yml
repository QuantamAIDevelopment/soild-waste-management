trigger:
- none   # enable when ready

pool:
  vmImage: ubuntu-latest

variables:
  acrName: "allvysharedacr"
  acrLoginServer: "$(acrName).azurecr.io"
  imageName: "swm-route-optimizer"
  buildTag: "$(Build.BuildId)"

steps:

# 1. Checkout
- checkout: self
  clean: true

# 2. Azure Login + ACR Login
- task: AzureCLI@2
  displayName: "Azure Login + ACR Login"
  inputs:
    azureSubscription: "agent-route-final-sc"
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      echo "Logging into ACR..."
      az acr login --name $(acrName)

# 3. Enable Docker Buildx (MANDATORY)
- script: |
    docker buildx create --name multiarch-builder --use
    docker buildx inspect --bootstrap
  displayName: "Enable Docker Buildx"

# 4. Build & Push Multi-Arch Image (amd64 + arm64)
- script: |
    docker buildx build \
      --platform linux/amd64,linux/arm64 \
      -t $(acrLoginServer)/$(imageName):$(buildTag) \
      -t $(acrLoginServer)/$(imageName):latest \
      --push \
      .
  displayName: "Build & Push Multi-Arch Docker Image"

# 5. Copy Kubernetes Manifests
- task: CopyFiles@2
  displayName: "Copy Kubernetes Manifests"
  inputs:
    contents: "manifests/**/*.yaml"
    targetFolder: "$(Build.ArtifactStagingDirectory)/manifests"

# 6. Publish Manifests
- task: PublishBuildArtifacts@1
  displayName: "Publish Manifest Artifact"
  inputs:
    pathToPublish: "$(Build.ArtifactStagingDirectory)/manifests"
    artifactName: "manifests"
    publishLocation: "Container"
