trigger: none
 
variables:
  k8sNamespace: default
 
stages:
- stage: Deploy
  displayName: Deploy to AKS
  jobs:
  - deployment: DeployJob
    displayName: AKS Deployment
    environment: aks-prod
    pool:
      vmImage: ubuntu-latest
 
    strategy:
      runOnce:
        deploy:
          steps:
 
          # ðŸ”½ DOWNLOAD MANIFESTS (SPECIFIC PROJECT + PIPELINE)
          - task: DownloadPipelineArtifact@2
            displayName: Download Kubernetes Manifests
            inputs:
              source: specific
              project: SWM-ROUTE-FINAL        # ðŸ”´ REQUIRED
              pipeline: swm-route-final-build
              runVersion: latest
              artifact: manifests
              path: $(System.DefaultWorkingDirectory)
 
          # ðŸ”§ MANUAL VARIABLE SUBSTITUTION
          - task: PowerShell@2
            displayName: Replace Variables in Secrets
            inputs:
              targetType: 'inline'
              script: |
                $secretsFile = "$(System.DefaultWorkingDirectory)/secrets.yaml"
                $content = Get-Content $secretsFile -Raw
                $content = $content -replace '#{SWM_API_BASE_URL}#', '$(SWM_API_BASE_URL)'
                $content = $content -replace '#{EXTERNAL_UPLOAD_URL}#', '$(EXTERNAL_UPLOAD_URL)'
                Set-Content $secretsFile $content
                Write-Host "Variables replaced in secrets.yaml"
                Write-Host "Content preview:"
                Get-Content $secretsFile | Select-Object -First 10
 
          # ðŸš€ DEPLOY TO AKS
          - task: KubernetesManifest@1
            displayName: Deploy to AKS
            inputs:
              action: deploy
              enableRolloutStatus: false
              connectionType: azureResourceManager
              azureSubscriptionConnection: agent-route-final-sc
              azureResourceGroup: rg-allvy-core-infra
              kubernetesCluster: allvy-apps-aks
              namespace: $(k8sNamespace)
              enableVariableSubstitution: true
              manifests: |
                $(System.DefaultWorkingDirectory)/service.yaml
                $(System.DefaultWorkingDirectory)/deployment.yaml
                $(System.DefaultWorkingDirectory)/secrets.yaml
 