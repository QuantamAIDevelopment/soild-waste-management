trigger:
- none

variables:
  acrName: allvysharedacr
  acrLoginServer: $(acrName).azurecr.io
  imageName: swm-route-optimizer
  k8sNamespace: default

stages:

# =========================
# STAGE 1 — BUILD
# =========================
- stage: Build
  displayName: Build & Push Image
  jobs:
  - job: BuildJob
    pool:
      vmImage: ubuntu-latest
    steps:

    - checkout: self
      clean: true

    - task: AzureCLI@2
      displayName: Azure Login + ACR Login
      inputs:
        azureSubscription: agent-route-final-sc
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          az acr login --name $(acrName)

    - script: |
        docker buildx create --use
        docker buildx inspect --bootstrap
      displayName: Enable Docker Buildx

    - script: |
        docker buildx build \
          --platform linux/amd64,linux/arm64 \
          -t $(acrLoginServer)/$(imageName):$(Build.BuildId) \
          -t $(acrLoginServer)/$(imageName):latest \
          --push \
          .
      displayName: Build & Push Multi-Arch Image

    - task: CopyFiles@2
      displayName: Copy Kubernetes Manifests
      inputs:
        contents: manifests/*.yaml
        targetFolder: $(Build.ArtifactStagingDirectory)/manifests

    - task: PublishBuildArtifacts@1
      displayName: Publish Manifests
      inputs:
        pathToPublish: $(Build.ArtifactStagingDirectory)/manifests
        artifactName: manifests


# =========================
# STAGE 2 — DEPLOY
# =========================
- stage: Deploy
  displayName: Deploy to AKS
  dependsOn: Build
  jobs:
  - deployment: DeployJob
    environment: aks-prod
    pool:
      vmImage: ubuntu-latest
    strategy:
      runOnce:
        deploy:
          steps:

          - task: DownloadBuildArtifacts@1
            displayName: Download Manifests
            inputs:
              buildType: current
              artifactName: manifests
              downloadPath: $(System.DefaultWorkingDirectory)

          - task: KubernetesManifest@1
            displayName: Deploy to AKS
            inputs:
              action: deploy
              connectionType: azureResourceManager
              azureSubscriptionConnection: agent-route-final-sc
              azureResourceGroup: rg-allvy-core-infra
              kubernetesCluster: allvy-apps-aks
              namespace: $(k8sNamespace)
              manifests: |
                $(System.DefaultWorkingDirectory)/_QuantamAIDevelopment.soild-waste-management/manifests/manifests/*.yaml
